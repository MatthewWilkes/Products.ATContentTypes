<html xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    metal:use-macro="container/main_template/macros/master"
    i18n:domain="plone">
<metal:head fill-slot="javascript_head_slot">
    <script type="text/javascript"
            tal:attributes="src string:$portal_url/DynamicOptionList.js">
    </script>
    <script type="text/javascript">
        var opt_list = new DynamicOptionList();
        opt_list.addDependentFields("field","criterion_type");
        opt_list.setFormName("criteria_select");
        window.onload = initDynamicOptionLists
    </script>
</metal:head>

<body>

<div metal:fill-slot="main">

    <script>
        function showHelp(selectedItem, helpElementId){
             helpElement = document.getElementById(helpElementId);
             elementTooltip = selectedItem.title;
             if (elementTooltip!='')
                {
                    helpText = elementTooltip
                } else {
                    helpText = '&nbsp;'
                }
             if (helpElement) {helpElement.innerHTML = helpText;}
            }
    </script>
    
    <h1>
        <span i18n:translate="heading_criteria_for" tal:omit-tag="">
            Criteria for
            <span i18n:name="title" tal:content="here/title_or_id" tal:omit-tag="" />
        </span>
    </h1>

    <form action=""
          method="post"
          tal:attributes="action template/getId"
          tal:define="criteria here/listSearchCriteria;
                      errors options/state/getErrors|nothing;
                     "
          tal:condition="criteria">

        <table class="listing" style="font-size: 100%;" >
            <thead>

                <tr>
                   <th>&nbsp;</th>
                   <th i18n:translate="table_criteria_field">Field</th>
                   <th i18n:translate="table_criterion_details">Criterion Details</th>
                </tr>

            </thead>
            
            <tbody>    
                <tal:criteria repeat="criterion criteria">
                    <tr tal:define="oddrow repeat/criterion/odd;" 
                        tal:attributes="class python:test(oddrow, 'even', 'odd')"
                        style="vertical-align: top;">
                      <span metal:use-macro="here/atct_macros/macros/criterion_edit" />
                    </tr>  
                </tal:criteria>
            </tbody>
            
        </table>
        <input type="hidden" name="form.submitted" value="1" />

        <div class="formControls">

          <input class="context"
                 type="submit"
                 value="Save"
                 name="form.button.Save"
                 tabindex=""
                 i18n:attributes="value"
                 tal:attributes="tabindex tabindex/next;"
                 />
          <input class="context"
                 type="submit"
                 value="Remove"
                 name="form.button.Remove"
                 tabindex=""
                 i18n:attributes="value"
                 tal:attributes="tabindex tabindex/next;"
                 />
          <input class="standalone"
                 type="submit"
                 value="Cancel"
                 name="form.button.Cancel"
                 tabindex=""
                 i18n:attributes="value"
                 tal:attributes="tabindex tabindex/next;"
                 />
        </div>

     </form>

    <form action=""
          name="criteria_select"
          method="post" 
          tal:attributes="action template/getId"
          tal:define="errors options/state/getErrors|nothing;
                     ">


        <fieldset>

            <legend i18n:translate="legend_add_new_search_criteria">Add New Search Criteria</legend>

            <div class="field" style="float:left">
        
                <label for="field" i18n:translate="label_criteria_field_name">Field name</label>

                <div class="formHelp"
                     id="fieldHelp"
                     i18n:translate="help_criteria_field_name">
                    List Available Fields
                </div>


        
            <select name="field"
                    id="field"
                    tabindex=""
                    onchange=""
                    tal:define="fields here/listAvailableFields;"
                    tal:attributes="tabindex tabindex/next;
                                    onchange string:javascript:showHelp(this.options[this.selectedIndex], 'fieldHelp');; opt_list.change(this);">

                    <tal:options tal:repeat="field fields">
                        <script type="text/javascript"
                                tal:define="name python:field[0];
                                    allowed python:here.allowedCriteriaForField(name, 1);
                                    allowed_str python:'\''+'\',\''.join(allowed)+'\''"
                                tal:content="string:opt_list.forValue('$name').addOptionsTextValue($allowed_str);;"/>

                        <option value="" 
                            tal:define="explanation python:field[2]"
                            tal:attributes="value python:field[0];
                                            title python:explanation"
                            tal:content="python:field[1]">Field</option>
                    </tal:options>
                </select>

            </div>
        
            <div class="field">

                <label for="criterion_type" i18n:translate="label_criteria_type">Criteria type</label>

                <div class="formHelp" i18n:translate="help_criteria_type">
                    Criteria does match
                </div>
        
                <select name="criterion_type"
                    id="criterion_type"
                    tabindex=""
                    tal:define="types here/listSearchCriteriaTypes;"
                    tal:attributes="tabindex tabindex/next;">

                    <script>opt_list.printOptions("criterion_type")</script>
                    
                    <option value="" tal:repeat="type types"
                                     tal:attributes="value type/name"
                                     i18n:translate=""
                                     tal:content="type/description">Type</option>

                </select>
        
            </div>
        <input type="hidden" name="form.submitted" value="1" />            

        <div class="formControls">
          <input class="context"
                 type="submit"
                 value="Add"
                 name="form.button.AddCriterion"
                 tabindex=""
                 i18n:attributes="value"
                 tal:attributes="tabindex tabindex/next;"
                 />
        </div>
        
        </fieldset>
    
    </form>


    <form action="" 
          method="post" 
          tal:attributes="action template/getId"
          tal:define="errors options/state/getErrors|nothing">


        <fieldset>
    
            <legend i18n:translate="legend_set_sort_order">Set Sort Order</legend>

            <div class="field" style="float:left">
        
                <label for="field" i18n:translate="label_criteria_field_name">Field Name</label>
        
                <div class="formHelp"
                     id="fieldHelpSort"
                     i18n:translate="help_criteria_field_name">
                    List Available Fields
                </div>

                    <select name="field"
                            id="field"
                            tabindex=""
                            tal:define="fields here/listSortFields"
                            tal:attributes="tabindex tabindex/next;
                                            onchange string:javascript:showHelp(this.options[this.selectedIndex], 'fieldHelpSort');">

                         <option value="no_sort" 
                                 tal:attributes="selected python:not here.hasSortCriterion();"
                                 i18n:translate="no_sort_order">No sort order</option>

                         <tal:block tal:repeat="field  fields">
                             <option value="" 
                                     tal:define="explanation python:field[2]"
                                     tal:attributes="value python:field[0];
                                                     selected python:here.hasSortCriterion() and here.getSortCriterion().field==field[0];
                                                     title explanation"
                                     tal:content="python:field[1]">Field</option>
                         </tal:block>
                    </select>

                 </div>


                 <div class="field">
                     <label for="reversed" i18n:translate="label_sort_reverse">Reverse</label>
                     <div class="formHelp"
                     i18n:translate="help_sort_reverse">Reverse display order</div>

                     <input class="noborder"
                            type="checkbox"
                            value="on"
                            tal:attributes="checked
                            python:here.hasSortCriterion() and here.getSortCriterion().getReversed()"
                            name="reversed" 
                            id="reversed"/>
                 </div>
                                                                                                                      
        
        <input type="hidden" name="form.submitted" value="1" />            
        <input type="hidden" name="criterion_type" value="ATSortCriterion" />            

        <div class="formControls" style="clear:both">
          <input class="context"
                 type="submit"
                 value="Save"
                 name="form.button.SetSortCriterion"
                 tabindex=""
                 i18n:attributes="value"
                 tal:attributes="tabindex tabindex/next;"
                 />
        </div>
        
        </fieldset>
    
    </form>


</div>
</body>
</html>
